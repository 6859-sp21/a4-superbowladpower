<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="initial-scale=1, width=device-width">

        <!-- Load d3.js -->
        <script src="https://d3js.org/d3.v6.js"></script>
        <!-- Load css -->
        <link href="styles.css" rel="stylesheet">

        <title>Superbowl Ad Trend</title>
    </head>
    
    <body>
        <h1>Superbowl Ad Trend</h1>

        <!-- Year Slider -->
        <div>
            <!-- <label for="yearRange">Year</label> -->
            <input type="range" min="2000" max="2020" value="2020" class="slider" id="yearRange">
            <p>Year: <span id="yearValue"></span></p>
            <br>
        </div>
        
        <!-- Ad traits checkboxex-->
        <div>
            <input type="checkbox" id="use_sex">
            <label for="use_sex">Sex</label>
            <input type="checkbox" id="funny">
            <label for="funny">Funny</label>
            <input type="checkbox" id="product">
            <label for="product">Show products quickly</label>
            <input type="checkbox" id="patriotic">
            <label for="patriotic">Patriotic</label>
            <input type="checkbox" id="celebrity">
            <label for="celebrity">Celebrity</label>
            <input type="checkbox" id="danger">
            <label for="danger">danger</label>
            <input type="checkbox" id="animals">
            <label for="animals">Animals</label>
        </div>
        
        <!-- <div id="bubble-chart" style="width:520px;height:420px;">
        </div> -->

        <!-- Bubble chart -->
        <svg id="bubble-chart"></svg>
        <!-- Tooltip -->
        <div class="tooltip">
            <img alt="" />
            <div>
                <a></a>
                <span></span>
            </div>
        </div>

        <script>

            // ------------------------------------------------------------------------
            // Implement year slider and trait checkboxes. This part is still work in progress. 
            // ------------------------------------------------------------------------
            var slider = document.getElementById("yearRange");
            var output = document.getElementById("yearValue");
            output.innerHTML = slider.value;
            var newYear = 2020;
            
            d3.csv("https://raw.githubusercontent.com/6859-sp21/a4-superbowladpower/main/data/superbowl-ad-youtube.csv").then(function(data) {
                // Convert data into the correct data type
                data.forEach(function(d) {
                    // d.year= new Date(+d.year, 0, 1)
                    d.year = +d.year;
                    d.view_count = +d.view_count;
                    d.like_count = +d.like_count;
                    d.dislike_count = +d.dislike_count;
                    d.comment = +d.comment;
                });
                
                // Debug
                console.log(data);

                yearUpdate(newYear);

                slider.oninput = function() {
                    output.innerHTML = this.value;
                    newYear = + this.value;
                    yearUpdate(newYear);
                }

                function yearUpdate(newYear){
                    newData = data.filter(d => d.year === newYear);
                    console.log(newData);
                }

                d3.select("#use_sex")
                    .on("change", checkboxUpdate);

                // Update the checkbox criteria. To do: how to make it a generic function
                function checkboxUpdate(){
                    if(d3.select("#use_sex").property("checked")){
                        newData = newData.filter(d => d.use_sex == "TRUE");
                    } 
                    else {
                        // Add back the false values of that year
                        add = data.filter(d => d.year === newYear);
                        add = add.filter(d => d.use_sex != "True"); // need code cleaning. combine the two filters
                        newData = newData.concat(add);
                    }
                    console.log(newData);			
                }
                
                // ------------------------------------------------------------------------
                // The next part is showing all the data on the bubble chart. Filter and slider has not been linked.
                // ------------------------------------------------------------------------

                // Set up canvas dimensions
                const width = window.innerWidth;
                const height = window.innerHeight;

                // Set up color scale based on brand
                const colorScale = d3.scaleOrdinal()
                    .domain(data.map(d => d.brand))
                    .range(d3.schemeTableau10);

                // construct bubble function
                const bubble = data => d3.pack()
                    .size([width, height])
                    .padding(2)(d3.hierarchy({ children: data }).sum(d => d.like_count));

                const svg = d3.select('#bubble-chart')
                    .style('width', width)
                    .style('height', height);
                
                const root = bubble(data);
                const tooltip = d3.select('.tooltip');

                // Data join
                const node = svg.selectAll()
                    .data(root.children)
                    .enter().append('g')
                    .attr('transform', `translate(${width / 2}, ${height / 2})`);
                
                // Draw circles and add hover and click effects
                const circle = node.append('circle')
                    .style('fill', d => colorScale(d.data.brand))
                    .on('mouseover', function (e, d) {
                        tooltip.select('img').attr('src', d.data.thumbnail);
                        tooltip.select('a').attr('href', d.data.superbowl_ads_dot_com_url).text(d.data.title);
                        tooltip.select('span').attr('class', d.data.brand).text(d.data.brand);
                        tooltip.style('visibility', 'visible');

                        d3.select(this).style('stroke', '#222');
                    })
                    .on('mousemove', e => tooltip.style('top', `${e.pageY}px`)
                                                .style('left', `${e.pageX + 10}px`))
                    .on('mouseout', function () {
                        d3.select(this).style('stroke', 'none');
                        return tooltip.style('visibility', 'hidden');
                    })
                    .on('click', (e, d) => window.open(d.data.superbowl_ads_dot_com_url));
                
                // Add title label to bubble
                const label = node.append('text')
                    .attr('dy', 2)
                    .text(d => d.data.title.substring(0, d.r / 3));

                // Add animation transition effects
                node.transition()
                    .ease(d3.easeExpInOut)
                    .duration(1000)
                    .attr('transform', d => `translate(${d.x}, ${d.y})`);
                
                circle.transition()
                    .ease(d3.easeExpInOut)
                    .duration(1000)
                    .attr('r', d => d.r);
                
                label.transition()
                    .delay(700)
                    .ease(d3.easeExpInOut)
                    .duration(1000)
                    .style('opacity', 1)

            });
        </script>
    </body>

</html>
